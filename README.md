# èœå•æµ‹è¯•å·¥å…·ï¼ˆMenu Testerï¼‰

åŸºäº Playwright ä¸ Midscene.js çš„æ™ºèƒ½èœå•æµ‹è¯• CLI å·¥å…·ï¼Œç”¨äºè‡ªåŠ¨å‘ç°å¹¶éªŒè¯ç®¡ç†åå°çš„å¯¼èˆªèœå•ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ¤– **AI èœå•å‘ç°**ï¼šè‡ªåŠ¨è¯†åˆ«å¹¶æµ‹è¯•é¡µé¢èœå•
- ğŸ” **ä»¤ç‰Œæ³¨å…¥**ï¼šæ”¯æŒ Cookie / LocalStorage / Header å¤šç§æ–¹å¼
- ğŸ“Š **è¿›åº¦è¿½è¸ª**ï¼šæ”¯æŒæ–­ç‚¹ç»­è·‘ã€ç»Ÿè®¡ä¸ç»“æœè¾“å‡º
- ğŸ›¡ï¸ **ç¨³å¥å®¹é”™**ï¼šå¼‚å¸¸å¤„ç†ã€è‡ªåŠ¨é‡è¯•
- âš¡ **å¿«é€Ÿæ ¡éªŒ**ï¼šé»˜è®¤ 6s é¡µé¢è¶…æ—¶
- ğŸ“¸ **æˆªå›¾å¯é€‰**ï¼šç”¨äºè°ƒè¯•ä¸è¯æ®ç•™å­˜

## ç¯å¢ƒè¦æ±‚

- Node.js >= 18.0.0
- å¯ç”¨çš„ AI æ¨¡å‹è®¿é—®ï¼ˆOpenAI/Anthropic æˆ–å…¬å¸ç½‘å…³ï¼‰

## å®‰è£…

```bash
# å…¨å±€å®‰è£…ï¼ˆæ¨èï¼‰
npm install -g @hik-cloud/midscene-menu-tester

# å¦‚éœ€æ‰‹åŠ¨å®‰è£…æµè§ˆå™¨
npx playwright install chromium
```

## é…ç½®

### ç¯å¢ƒå˜é‡ï¼ˆæ¨èå…¶ä¸€ï¼‰

```bash
# ä¸´æ—¶è®¾ç½®å¹¶è¿è¡Œï¼ˆå•æ¬¡ï¼‰
OPENAI_API_KEY=sk-xxx menu-tester test --config config.json

# ä¼šè¯çº§è®¾ç½®
export OPENAI_API_KEY=sk-xxx

# ä½¿ç”¨ .envï¼ˆåœ¨è¿è¡Œç›®å½•åˆ›å»ºï¼‰
echo "OPENAI_API_KEY=sk-xxx" > .env
```

å¯é€‰ï¼š`OPENAI_BASE_URL` æŒ‡å‘å…¬å¸å†…ç½‘ç½‘å…³ï¼Œå®¢æˆ·ç«¯æ— éœ€æŒæœ‰çœŸå® Keyã€‚

### é…ç½®æ–‡ä»¶ç¤ºä¾‹

**åŸºç¡€é…ç½®ï¼š**
```json
{
  "url": "https://admin.example.com",
  "token": "your-access-token",
  "tokenMethod": "cookie",
  "tokenName": "access_token",
  "mode": "hybrid",
  "depth": 2,
  "timeout": 6000,
  "headless": true,
  "retry": 2,
  "skip": "logout,exit,æ³¨é”€",
  "screenshots": false,
  "verbose": false
}
```

**å•æ–‡ä»¶é…ç½®ï¼ˆå«è·¯ç”±ï¼‰ï¼š**
```json
{
  "url": "https://admin.example.com",
  "token": "your-access-token",
  "mode": "route",
  "routes": [
    { "menuText": "é¦–é¡µ", "url": "https://admin.example.com/home" },
    { "menuText": "ç”¨æˆ·ç®¡ç†", "url": "https://admin.example.com/users" },
    { "menuText": "ç³»ç»Ÿè®¾ç½®", "url": "https://admin.example.com/settings" }
  ]
}
```

**å®Œæ•´é…ç½®ï¼ˆå«é¡µé¢æ–­è¨€ï¼‰ï¼š**
```json
{
  "url": "https://admin.example.com",
  "token": "your-access-token",
  "mode": "hybrid",
  "timeout": 6000,
  "headless": true,
  "screenshots": false,
  "pageAssertions": {
    "enabled": true,
    "midsceneTextCheck": {
      "enabled": true,
      "timeout": 8000,
      "concurrency": 2,
      "checks": [
        {
          "name": "éç™½å±æ£€æŸ¥",
          "type": "aiBoolean",
          "prompt": "é¡µé¢æ˜¯å¦æ˜¯ç™½å±ã€ç©ºç™½é¡µé¢æˆ–åªæ˜¾ç¤ºåŠ è½½çŠ¶æ€ï¼Ÿ",
          "failOnTrue": true,
          "failFast": false,
          "timeout": 5000,
          "failureMessage": "æ£€æµ‹åˆ°ç™½å±æˆ–ç©ºç™½é¡µé¢"
        },
        {
          "name": "æ— æƒé™é”™è¯¯æ£€æŸ¥",
          "type": "aiBoolean",
          "prompt": "é¡µé¢æ˜¯å¦æ˜¾ç¤ºæƒé™ç›¸å…³çš„é”™è¯¯ä¿¡æ¯ï¼Ÿ",
          "failOnTrue": true,
          "failFast": true,
          "timeout": 5000,
          "failureMessage": "æ£€æµ‹åˆ°æƒé™é”™è¯¯"
        }
      ]
    }
  }
}
```

## ä½¿ç”¨æ–¹å¼

### Web é…ç½®ç•Œé¢ï¼ˆæ¨èï¼‰

```bash
menu-tester serve              # å¯åŠ¨
menu-tester serve --port 8080  # æŒ‡å®šç«¯å£
menu-tester serve --no-open    # ä¸è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨
```

æµè§ˆå™¨ä¸­å¯å®Œæˆï¼šåŸºç¡€é…ç½®ã€è·¯ç”±ç®¡ç†ã€é¡µé¢æ–­è¨€ã€å¯¼å‡ºé…ç½®ã€‚

### å‘½ä»¤è¡Œ

```bash
# ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰
menu-tester test --config config.json

# å•æ–‡ä»¶é…ç½®ï¼ˆå«è·¯ç”±ï¼‰
menu-tester test --config config-with-routes.json

# AI æ¨¡å¼
menu-tester test --mode ai --config config.json

# æ··åˆæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰
menu-tester test --mode hybrid --config config.json

# è·¯ç”±æ¨¡å¼ï¼ˆä¼ ç»Ÿæ–¹å¼ï¼šåˆ†ç¦»çš„è·¯ç”±æ–‡ä»¶ï¼‰
menu-tester routes import routes.json
menu-tester test --mode route

# è¯¦ç»†æ—¥å¿—
menu-tester test --config config.json --verbose
```

## é¡µé¢æ–­è¨€é…ç½®

é¡µé¢æ–­è¨€ç”¨äºæ™ºèƒ½éªŒè¯é¡µé¢å†…å®¹ï¼Œæ£€æµ‹å¸¸è§é”™è¯¯ï¼ˆç™½å±ã€æƒé™é”™è¯¯ã€æ¥å£é”™è¯¯ç­‰ï¼‰ã€‚

### é…ç½®è¯´æ˜

**`pageAssertions.enabled`** - é¡µé¢æ–­è¨€æ€»å¼€å…³ï¼ˆé»˜è®¤ trueï¼‰

**`midsceneTextCheck`** - AI æ–‡æœ¬æ£€æŸ¥é…ç½®ï¼š
- `enabled` - å¯ç”¨ AI è¯­ä¹‰æ£€æŸ¥
- `timeout` - å•ä¸ªæ£€æŸ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
- `concurrency` - å¹¶å‘æ£€æŸ¥æ•°ï¼ˆ1-5ï¼‰
- `checks` - æ£€æŸ¥é¡¹æ•°ç»„ï¼ˆå¯è‡ªå®šä¹‰ï¼‰

### æ£€æŸ¥é¡¹é…ç½®

æ¯ä¸ªæ£€æŸ¥é¡¹åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

- **`name`** - æ£€æŸ¥åç§°ï¼ˆå¦‚ï¼š"éç™½å±æ£€æŸ¥"ï¼‰
- **`type`** - æ£€æŸ¥ç±»å‹ï¼ˆ`aiBoolean` æˆ– `aiQuery`ï¼‰
- **`prompt`** - AI æ£€æŸ¥æç¤ºè¯ï¼ˆæè¿°è¦æ£€æŸ¥çš„å†…å®¹ï¼‰
- **`failOnTrue`** - æ£€æµ‹ä¸ºçœŸæ—¶å¤±è´¥ï¼ˆç”¨äºæ£€æµ‹é”™è¯¯æƒ…å†µï¼‰
- **`failFast`** - ç«‹å³å¤±è´¥ï¼ˆæ­¤é¡¹å¤±è´¥æ—¶è·³è¿‡åç»­æ£€æŸ¥ï¼‰
- **`timeout`** - å•é¡¹è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
- **`failureMessage`** - å¤±è´¥æ—¶çš„æç¤ºæ¶ˆæ¯

### é»˜è®¤æ£€æŸ¥é¡¹

1. **éç™½å±æ£€æŸ¥** - æ£€æµ‹é¡µé¢æ˜¯å¦ç™½å±æˆ–ç©ºç™½ï¼ˆ`failFast: false`ï¼‰
2. **æ— æƒé™é”™è¯¯æ£€æŸ¥** - æ£€æµ‹æƒé™é”™è¯¯ï¼ˆ`failFast: true`ï¼Œç«‹å³å¤±è´¥ï¼‰
3. **æ— æ¥å£é”™è¯¯æ£€æŸ¥** - æ£€æµ‹æ¥å£/ç½‘ç»œé”™è¯¯ï¼ˆ`failFast: false`ï¼‰
4. **æœ‰æ•ˆä¸šåŠ¡å†…å®¹æ£€æŸ¥** - æ£€æµ‹æ˜¯å¦æœ‰æœ‰æ•ˆä¸šåŠ¡å†…å®¹ï¼ˆ`failFast: false`ï¼‰

### Web ç•Œé¢ç®¡ç†

åœ¨ Web é…ç½®ç•Œé¢çš„"é¡µé¢æ–­è¨€"é€‰é¡¹å¡ä¸­ï¼Œå¯ä»¥ï¼š
- âœ… å¯ç”¨/ç¦ç”¨é¡µé¢æ–­è¨€
- â• æ·»åŠ è‡ªå®šä¹‰æ£€æŸ¥é¡¹
- âœï¸ ç¼–è¾‘æ£€æŸ¥é¡¹çš„æç¤ºè¯å’Œé…ç½®
- ğŸ—‘ï¸ åˆ é™¤ä¸éœ€è¦çš„æ£€æŸ¥é¡¹
- ğŸ”„ æ¢å¤ä¸ºé»˜è®¤çš„ 4 ä¸ªæ£€æŸ¥é¡¹

## æˆªå›¾ä¿å­˜

- **å¼€å¯æ–¹å¼**ï¼šåœ¨é…ç½®ä¸­è®¾ç½® `"screenshots": true`ï¼Œæˆ–åœ¨ Web é…ç½®ç•Œé¢å‹¾é€‰"æˆªå›¾ä¿å­˜"ã€‚
- **è§¦å‘æ—¶æœº**ï¼šæ¯æ¬¡é¡µé¢éªŒè¯å®Œæˆåï¼ˆæ— è®ºæˆåŠŸ/å¤±è´¥ï¼‰ï¼Œéƒ½ä¼šå°è¯•æˆªå›¾ä½œä¸ºè¯æ®ã€‚
- **ä¿å­˜ä½ç½®**ï¼šç”± Midscene ä»£ç†ç»Ÿä¸€ç®¡ç†ï¼Œè½ç›˜è‡³é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `midscene_run/` çš„æœ¬æ¬¡ä¼šè¯ç›®å½•ä¸­ï¼›åŒæ—¶ä¼šåœ¨ `midscene_run/report/{ä¼šè¯ID}.html` æŠ¥å‘Šä¸­å¼•ç”¨å±•ç¤ºã€‚
- **å‘½åè§„åˆ™**ï¼š`menu-{èœå•id}-{success|failed}-{æ—¶é—´æˆ³}.png`ï¼Œä¾¿äºå®šä½ä¸æ¯”å¯¹ã€‚
- **æŸ¥çœ‹æ–¹å¼**ï¼š
  - è¿è¡Œç»“æŸåï¼Œæ‰“å¼€ `midscene_run/report/{ä¼šè¯ID}.html` æŸ¥çœ‹å¯è§†åŒ–æŠ¥å‘Šä¸æˆªå›¾ã€‚
  - è‹¥éœ€åŸå›¾ï¼Œè¿›å…¥ `midscene_run/` ä¸‹æœ€æ–°ä¼šè¯ç›®å½•ï¼ŒæŒ‰ä¸Šè¿°æ–‡ä»¶åå‰ç¼€æŸ¥æ‰¾ã€‚

## æˆªå›¾å¯¹æ¯”ï¼ˆè§†è§‰å›å½’æµ‹è¯•ï¼‰

æ”¯æŒåƒç´ çº§æˆªå›¾å¯¹æ¯”ï¼Œè‡ªåŠ¨æ£€æµ‹UIå˜åŒ–ï¼Œé€‚ç”¨äºå›å½’æµ‹è¯•å’ŒCI/CDé›†æˆã€‚

### å¿«é€Ÿå¼€å§‹

**1. é…ç½®æˆªå›¾å¯¹æ¯”**

åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ï¼š
```json
{
  "screenshots": true,
  "screenshotComparison": {
    "enabled": true,
    "threshold": 0.1,
    "baselineDir": "./screenshots/baseline",
    "diffDir": "./screenshots/diff",
    "updateBaseline": false,
    "failOnDiff": false
  }
}
```

**2. é¦–æ¬¡è¿è¡Œï¼ˆå»ºç«‹åŸºçº¿ï¼‰**
```bash
# è®¾ç½® updateBaseline: trueï¼Œä½¿ç”¨AIæ¨¡å¼å»ºç«‹åŸºçº¿
menu-tester --config config/hik-config.json
```

**3. å›å½’æµ‹è¯•ï¼ˆå¯¹æ¯”æ¨¡å¼ï¼‰**
```bash
# è®¾ç½® updateBaseline: falseï¼Œä½¿ç”¨è·¯ç”±æ¨¡å¼å¿«é€Ÿå¯¹æ¯”
menu-tester routes test --config config/hik-config.json
```

### æ ¸å¿ƒç‰¹æ€§

- âœ… **ç»Ÿä¸€Keyç”Ÿæˆ**ï¼šèœå•æ¨¡å¼å’Œè·¯ç”±æ¨¡å¼ä½¿ç”¨ç›¸åŒçš„URLæ ‡å‡†åŒ–ç­–ç•¥
- âœ… **åƒç´ çº§å¯¹æ¯”**ï¼šä½¿ç”¨ pixelmatch è¿›è¡Œç²¾ç¡®å¯¹æ¯”
- âœ… **å¯è§†åŒ–å·®å¼‚å›¾**ï¼šè‡ªåŠ¨ç”Ÿæˆçº¢è‰²æ ‡æ³¨çš„å·®å¼‚å›¾
- âœ… **çµæ´»é…ç½®**ï¼šå¯è°ƒæ•´æ•æ„Ÿåº¦é˜ˆå€¼ï¼ˆ0-1ï¼‰

### ä½¿ç”¨åœºæ™¯

**AIå‘ç° + è·¯ç”±å›å½’**ï¼ˆæ¨èï¼‰
```bash
# Day 1: AIæ¨¡å¼å…¨é¢å‘ç°ï¼Œå»ºç«‹åŸºçº¿
menu-tester --config config.json  # updateBaseline=true

# Day 2-N: è·¯ç”±æ¨¡å¼å¿«é€Ÿå›å½’
menu-tester routes test --config config.json  # updateBaseline=false
```

### é…ç½®è¯´æ˜

| é…ç½®é¡¹ | è¯´æ˜ |
|--------|------|
| `enabled` | æ˜¯å¦å¯ç”¨æˆªå›¾å¯¹æ¯” |
| `threshold` | å·®å¼‚é˜ˆå€¼ï¼ˆ0-1ï¼‰ï¼Œè¶Šå°è¶Šä¸¥æ ¼ |
| `updateBaseline` | æ˜¯å¦æ›´æ–°åŸºçº¿æˆªå›¾ |
| `failOnDiff` | å‘ç°å·®å¼‚æ—¶æ˜¯å¦ç«‹å³å¤±è´¥ |

ğŸ“– **è¯¦ç»†æ–‡æ¡£**ï¼š[æˆªå›¾å¯¹æ¯”åŠŸèƒ½ä½¿ç”¨æŒ‡å—](./docs/screenshot-comparison-guide.md)

## å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

- **å¦‚ä½•æä¾› AI å¯†é’¥ï¼Ÿ** ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆä¸´æ—¶ã€exportã€æˆ– .envï¼‰ã€‚ä¸å»ºè®®æŠŠå¯†é’¥å†™å…¥ä»£ç æˆ–åŒ…å†…ã€‚
- **æˆªå›¾æœ‰ä»€ä¹ˆç”¨ï¼Ÿ** ä¾¿äºè°ƒè¯•å¤±è´¥ç”¨ä¾‹ã€ç”ŸæˆæŠ¥å‘Šè¯æ®ï¼ŒCI æ’æŸ¥æ›´ç›´è§‚ã€‚
- **token ä¸ OPENAI_API_KEY æœ‰ä½•åŒºåˆ«ï¼Ÿ** å‰è€…æ˜¯è¢«æµ‹ç³»ç»Ÿçš„è®¿é—®ä»¤ç‰Œï¼›åè€…æ˜¯è°ƒç”¨å¤§æ¨¡å‹çš„å‡­è¯ã€‚
- **ç»„ç»‡å†…å¦‚ä½•æ›´å®‰å…¨ï¼Ÿ** é…ç½® `OPENAI_BASE_URL` æŒ‡å‘å…¬å¸ç½‘å…³ï¼Œå®¢æˆ·ç«¯æ— éœ€çœŸå® Keyã€‚

## è®¸å¯è¯

MIT